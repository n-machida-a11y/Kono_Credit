<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>クレジット精算アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: "Helvetica Neue", Arial, sans-serif; }
    .navbar { background-color: #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: bold; color: white !important; display: flex; align-items: center; gap: 10px; }
    .nav-link { color: rgba(255,255,255,0.85) !important; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: all 0.2s; }
    .nav-link:hover, .nav-link.active { background-color: rgba(255,255,255,0.2); color: white !important; font-weight: bold; }
    .user-info { color: white; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 15px; margin-left: 10px; font-size: 0.9rem; }
    
    .drag-area { border: 2px dashed #dee2e6; border-radius: 12px; background: white; padding: 60px 20px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
    .drag-area:hover, .drag-area.active { border-color: #0d6efd; background-color: #f8faff; }
    .drag-icon-circle { width: 80px; height: 80px; background: #e7f1ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: #0d6efd; }
    
    .content-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e9ecef; overflow: hidden; padding: 20px; }
    .table thead th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; font-size: 0.85rem; }
    
    /* 修正：プレビューエリアの最適化 */
    .preview-container { background: #333; display: flex; align-items: center; justify-content: center; position: relative; overflow: auto; height: 100%; width: 100%; }
    #previewImage { max-width: 100%; max-height: 100%; object-fit: contain; }
    #previewPdf { width: 100%; height: 100%; border: none; }
    
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
    .spinner-border { width: 3rem; height: 3rem; border-width: 0.25em; }

    .thumbnail-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .thumbnail-item { position: relative; width: 80px; height: 80px; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .thumbnail-item img { width: 100%; height: 100%; object-fit: cover; }
    .btn-remove-thumb { position: absolute; top: 0; right: 0; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 0 0 0 4px; padding: 0 6px; font-size: 12px; }

    .modal-fullscreen .modal-body { overflow-y: hidden; }
    .detail-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 10px; }
    
    .btn-edit-unify { font-size: 0.75rem; padding: 2px 8px; white-space: nowrap; }

    @media (min-width: 992px) { 
      .preview-container { height: 100vh; } 
      .form-section { height: 100%; display: flex; flex-direction: column; } 
      .form-scroll-area { overflow-y: auto; flex-grow: 1; } 
    }
    @media (max-width: 991.98px) { 
      .modal-fullscreen .modal-body { overflow-y: auto !important; } 
      .preview-container { height: 40vh; min-height: 300px; width: 100%; }
      .drag-area { padding: 20px 10px; }
      .drag-icon-circle { width: 50px; height: 50px; margin-bottom: 10px; }
      .drag-icon-circle i { font-size: 1.2rem; }
      .content-card { padding: 1rem !important; }
    }
  </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner-border text-primary mb-3"></div><h5 id="loadingText">処理中...</h5></div>

<nav class="navbar navbar-expand-lg sticky-top mb-4">
  <div class="container-xl">
    <a class="navbar-brand" href="#"><i class="fas fa-file-invoice"></i> クレジット精算</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" onclick="switchView('apply')" href="#">① 登録画面</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchView('history')" href="#">② 全履歴・申請</a></li>
        <li class="nav-item approver-only" style="display:none;"><a class="nav-link" onclick="switchView('president')" href="#">③ 承認タスク</a></li>
        <li class="nav-item admin-only" style="display:none;"><a class="nav-link" onclick="switchView('admin')" href="#">④ 管理者画面</a></li>
      </ul>
      <div class="user-info text-end">
          <div id="userName" class="fw-bold">Guest</div>
          <div id="userRole" class="small opacity-75">Loading...</div>
          <div id="debugEmail" class="text-white-50" style="font-size: 0.6rem; margin-top: 2px;"></div>
      </div>
    </div>
  </div>
</nav>

<div class="container-xl pb-5">
  <div id="view-apply" class="view-section">
    <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-2"><h3 class="fw-bold text-dark m-0">① 経費データ登録</h3></div>
    <div id="uploadArea" class="content-card p-5 text-center mx-auto" style="max-width: 800px;">
      <input type="file" id="fileInput" multiple accept="image/*,application/pdf" style="display:none;" onchange="appendFiles(this.files)">
      
      <div class="drag-area" id="dragZone" ondragover="event.preventDefault(); this.classList.add('active');" ondragleave="this.classList.remove('active');" ondrop="handleDrop(event)">
        <div class="drag-icon-circle"><i class="fas fa-camera fa-2x"></i></div>
        <h4 class="fw-bold mb-3">領収書を登録する</h4>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
          <button class="btn btn-primary btn-lg px-5 shadow fw-bold" onclick="document.getElementById('fileInput').click()"><i class="fas fa-plus-circle me-2"></i>登録する</button>
        </div>
        <p class="text-muted mt-3 mb-0 small">ドラッグ＆ドロップでも追加可能 <span class="text-primary fw-bold">(複数枚対応)</span></p>
      </div>

      <div id="pendingFileList" class="thumbnail-list"></div>

      <div id="uploadActions" class="mt-4 pt-3 border-top" style="display:none;">
        <p class="mb-2 fw-bold text-success small"><span id="pendingCount">0</span> 枚の画像が選択されています</p>
        <button class="btn btn-success btn-lg px-5 shadow fw-bold" onclick="startAnalysis()">
          <i class="fas fa-robot me-2"></i>AI解析を開始する
        </button>
        <div class="mt-2">
            <button class="btn btn-link text-muted btn-sm" onclick="clearPendingFiles()">全てクリア</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-history" class="view-section" style="display:none;">
    <div class="d-flex justify-content-between mb-3 align-items-center"><h4>② 全履歴・申請</h4><button class="btn btn-sm btn-outline-primary" onclick="loadHistory()">更新</button></div>
    <div class="alert alert-primary py-2 d-flex justify-content-between align-items-center shadow-sm"><small>未申請項目を選択してまとめて申請</small><button id="btnBulkApply" class="btn btn-sm btn-primary fw-bold" disabled onclick="submitBulk()">一括申請</button></div>
    <div class="content-card p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th></th><th>操作</th><th>利用日</th><th>支払先</th><th>科目</th><th>金額</th><th>状態</th></tr></thead><tbody id="historyBody"></tbody></table></div></div>
  </div>

  <div id="view-president" class="view-section" style="display:none;">
    <div class="d-flex justify-content-between mb-3"><h4>③ 承認タスク</h4><div><button class="btn btn-sm btn-success me-2 fw-bold" onclick="approveSelected()">一括承認</button><button class="btn btn-sm btn-danger fw-bold" onclick="rejectSelectedPrepare()">差戻し</button></div></div>
    <div class="content-card p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th><input type="checkbox" onclick="toggleAll(this, '.pres-check')"></th><th width="100">詳細</th><th>申請者</th><th>利用日</th><th>店名</th><th class="text-end">金額</th></tr></thead><tbody id="presidentBody"></tbody></table></div></div>
  </div>

  <div id="view-admin" class="view-section" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3"><h4>④ 管理者画面</h4><div class="d-flex gap-2"><button class="btn btn-outline-success fw-bold" onclick="processAdminAction('checkBulk')">選択を確認済みにする</button><button class="btn btn-primary fw-bold" onclick="downloadCSV('kanjo')">CSV出力して完了</button></div></div>
    <div class="card mb-3 border-0 shadow-sm"><div class="card-body p-3"><div class="row g-2 align-items-center">
        <div class="col-md-3"><label class="form-label small fw-bold">対象月</label><input type="month" id="adminFilterMonth" class="form-control form-control-sm" onchange="renderAdminTable()"></div>
        <div class="col-md-3"><label class="form-label small fw-bold">検索</label><input type="text" id="adminFilterSearch" class="form-control form-control-sm" placeholder="店名・名前..." oninput="renderAdminTable()"></div>
        <div class="col-md-3"><label class="form-label small fw-bold">状態フィルタ</label><select id="adminFilterStatus" class="form-select form-select-sm" onchange="renderAdminTable()"><option value="all" selected>すべて</option><option value="approved">経理未チェック</option><option value="checked">経理チェック済</option></select></div>
        <div class="col-md-3 text-end pt-4"><span class="badge bg-light text-dark border shadow-sm"><span id="adminDisplayCount">0</span>件表示中</span></div>
    </div></div></div>
    <div class="content-card p-0"><div class="table-responsive" style="max-height: 60vh;"><table class="table table-hover align-middle mb-0" id="adminTable"><thead class="sticky-top bg-light"><tr><th width="40"><input type="checkbox" onclick="toggleAll(this, '.admin-check')"></th><th width="100">修正</th><th style="cursor:pointer" onclick="sortAdminData('date')">利用日</th><th>申請者</th><th>支払先</th><th>科目</th><th class="text-end">金額</th><th class="text-center">状態</th></tr></thead><tbody id="adminBody"></tbody></table></div></div>
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-body p-0 h-100">
    <input type="hidden" id="editId">
    <div class="row g-0 h-100">
      <!-- 修正：プレビューエリアをimgタグに変更 -->
      <div class="col-lg-6 bg-dark preview-container">
        <img id="previewImage" src="" alt="領収書プレビュー" style="display:none;">
        <iframe id="previewPdf" src="" style="display:none;"></iframe>
        <div id="noPreview" class="text-white text-center" style="display:none;"><i class="fas fa-eye-slash fa-3x mb-3"></i><br>プレビュー不可</div>
      </div>
      <div class="col-lg-6 h-100 d-flex flex-column form-section" style="background: #f5f7fa;">
        <div class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center shadow-sm"><h5 id="modalTitle" class="m-0 fw-bold">修正・確認</h5><div id="modalActions"></div></div>
        <div class="p-4 form-scroll-area">
          <div id="duplicateAlert" class="alert alert-warning mb-3 d-flex align-items-center" style="display:none;"><i class="fas fa-exclamation-triangle me-2"></i><div><strong>重複の可能性があります</strong><br><small>同じ日付、店名、金額のデータが既に存在します。</small></div></div>
          <div class="card border-0 shadow-sm mb-3"><div class="card-body"><div class="row g-3">
            <div class="col-6"><label class="form-label small fw-bold">申請日</label><input type="date" class="form-control" id="editDate"></div>
            <div class="col-6"><label class="form-label small fw-bold">使用者</label><input type="text" class="form-control bg-light" id="editUser" readonly></div>
            <div class="col-12"><label class="form-label small fw-bold">支払先</label><input type="text" class="form-control" id="editStore" placeholder="店舗名"></div>
            <div class="col-12 border-top pt-3"><div class="row align-items-center"><div class="col-5"><div class="form-check"><input type="checkbox" id="editInvoice" class="form-check-input"><label class="form-check-label small fw-bold">インボイス番号</label></div></div><div class="col-7 text-end"><label class="small text-muted d-block mb-1">税込合計</label><input type="number" class="form-control text-end fw-bold" id="editAmount" style="color: #0d6efd; font-size: 1.2rem;"></div></div></div>
            <div class="col-12"><label class="form-label small text-muted">全体メモ</label><input type="text" class="form-control form-control-sm" id="editGlobalMemo"></div>
          </div></div></div>
          
          <h6 class="fw-bold mt-4 mb-2"><i class="fas fa-list me-2"></i>明細入力</h6>
          <div id="detailItemsContainer"></div>
          <div class="edit-only-div mt-2"><button class="btn btn-sm btn-outline-success w-100" onclick="addDetailItem()">+ 明細を追加</button></div>
        </div>
      </div>
    </div>
  </div></div></div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header fw-bold text-danger">差戻し理由の入力</div><div class="modal-body"><textarea id="rejectCommentInput" class="form-control" rows="3" placeholder="理由を入力してください"></textarea></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button><button class="btn btn-danger" onclick="rejectConfirm()">差戻しを実行</button></div></div></div></div>

<datalist id="categoryList"></datalist>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentUser = null, historyData = [], detailData = [], editModal = null, rejectModal = null, pendingDrafts = [], currentDraftIndex = -1, pendingFiles = [], adminSortKey = 'date', adminSortOrder = 1;

window.onload = function() {
  try {
    editModal = new bootstrap.Modal(document.getElementById('editModal'));
    rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
    showLoading(true, '初期化中...');
    google.script.run.withSuccessHandler(function(user) {
      showLoading(false);
      if (!user || user.error) {
          document.getElementById('userName').textContent = 'Error';
          console.error("User fetch error:", user ? user.error : "Unknown");
          return;
      }
      currentUser = user;
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userRole').textContent = user.role;
      document.getElementById('debugEmail').textContent = user.email; 
      
      if(['社長','経理'].includes(user.role)) document.querySelectorAll('.approver-only').forEach(function(e){ e.style.display='block'; });
      if(['管理者','経理'].includes(user.role)) document.querySelectorAll('.admin-only').forEach(function(e){ e.style.display='block'; });
      loadMasters(); loadHistory();
      document.getElementById('adminFilterMonth').value = new Date().toISOString().slice(0,7);
    }).withFailureHandler(function(err) {
      showLoading(false);
      alert("初期化に失敗しました。再読み込みしてください。: " + err.message);
    }).getCurrentUser();
  } catch (e) { alert("Load Error: " + e.message); }
};

function switchView(viewName) {
  document.querySelectorAll('.view-section').forEach(function(e){ e.style.display = 'none'; });
  document.getElementById('view-' + viewName).style.display = 'block';
  document.querySelectorAll('.nav-link').forEach(function(e){ e.classList.remove('active'); });
  const target = document.querySelector('a[onclick="switchView(\'' + viewName + '\')"]');
  if(target) target.classList.add('active');
  
  const navbarCollapse = document.getElementById('navbarNav');
  if (navbarCollapse && navbarCollapse.classList.contains('show')) {
      const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
      if (bsCollapse) bsCollapse.hide();
  }

  if(viewName === 'history') loadHistory(); else if(viewName === 'president') loadPresidentData(); else if(viewName === 'admin') loadAdminData();
}

function renderAdminTable() {
    const tbody = document.getElementById('adminBody'), month = document.getElementById('adminFilterMonth').value, search = document.getElementById('adminFilterSearch').value.toLowerCase(), statusFilter = document.getElementById('adminFilterStatus').value;
    let filtered = historyData.filter(function(r) {
        const matchMonth = !month || (r.date && r.date.startsWith(month));
        const matchSearch = !search || (r.store && r.store.toLowerCase().includes(search)) || (r.user && r.user.toLowerCase().includes(search));
        const matchStatus = (statusFilter === 'all' || r.status === statusFilter);
        return matchMonth && matchSearch && matchStatus;
    });

    filtered.sort(function(a,b) {
        let valA = a[adminSortKey], valB = b[adminSortKey];
        if(adminSortKey === 'amount') { valA = Number(valA); valB = Number(valB); }
        return valA < valB ? -adminSortOrder : (valA > valB ? adminSortOrder : 0);
    });

    let html = "";
    filtered.forEach(function(r) {
        const dupIcon = r.isDuplicate ? '<span class="text-warning ms-1" title="重複の可能性"><i class="fas fa-exclamation-triangle"></i></span>' : '';
        const badge = r.status === 'checked' ? '<span class="badge bg-info">経理チェック済</span>' : '<span class="badge bg-warning text-dark">経理未チェック</span>';
        html += '<tr style="cursor:pointer" onclick="openEditFromHistory(\'' + r.id + '\', true)">' +
            '<td onclick="event.stopPropagation()"><input type="checkbox" class="admin-check" value="' + r.id + '"></td>' +
            '<td><button class="btn btn-outline-primary btn-edit-unify" onclick="event.stopPropagation(); openEditFromHistory(\''+r.id+'\', true)"><i class="fas fa-edit me-1"></i>修正・確認</button></td>' +
            '<td>' + r.date + '</td><td>' + r.user + '</td><td><b>' + r.store + '</b></td><td><small>' + (r.items && r.items[0] ? r.items[0].category : '-') + '</small></td>' +
            '<td class="text-end fw-bold">¥' + Number(r.amount).toLocaleString() + '</td><td class="text-center">' + badge + dupIcon + '</td>' +
            '</tr>';
    });
    tbody.innerHTML = html || '<tr><td colspan="8" class="text-center py-4 text-muted">対象データがありません</td></tr>';
    document.getElementById('adminDisplayCount').textContent = filtered.length;
}

function sortAdminData(key) { if(adminSortKey === key) adminSortOrder *= -1; else { adminSortKey = key; adminSortOrder = 1; } renderAdminTable(); }
function loadAdminData() { showLoading(true, '読込中...'); google.script.run.withSuccessHandler(function(data){ showLoading(false); historyData = data; renderAdminTable(); }).getHistoryData({view: 'admin'}); }
function processAdminAction(func) {
    const ids = Array.from(document.querySelectorAll('.admin-check:checked')).map(function(c){ return c.value; });
    if(!ids.length) return alert('選択してください');
    if(!confirm('実行しますか？')) return;
    showLoading(true); google.script.run.withSuccessHandler(function(){ showLoading(false); loadAdminData(); })[func](ids);
}

function downloadCSV(type) {
    const ids = Array.from(document.querySelectorAll('.admin-check:checked')).map(function(c){ return c.value; });
    if(!ids.length) return alert('選択してください');
    showLoading(true, 'CSV作成中...');
    google.script.run.withSuccessHandler(function(data){
        showLoading(false);
        if(!data || data.length <= 1) return alert('データがありません');
        const csvContent = data.map(function(row){ return row.map(function(c){ let s=String(c); return (s.includes(',')||s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s; }).join(','); }).join('\n');
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]), blob = new Blob([bom, csvContent], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "kanjo_" + new Date().toISOString().slice(0,10) + ".csv";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        if(confirm('CSV出力を完了しました。\nステータスを「CSV出力済み」に更新してリストから除外しますか？')) {
            showLoading(true); google.script.run.withSuccessHandler(function(){ showLoading(false); loadAdminData(); }).markAsExported(ids);
        }
    }).getDataForCSV(ids);
}

function appendFiles(fs) { Array.from(fs).forEach(function(f){ if(!pendingFiles.some(function(p){ return p.name === f.name && p.size === f.size; })) pendingFiles.push(f); }); renderPending(); }
function renderPending() {
    const c = document.getElementById('pendingFileList'), a = document.getElementById('uploadActions'); c.innerHTML = '';
    pendingFiles.forEach(function(f, i){
        const reader = new FileReader(), d = document.createElement('div'); d.className = 'thumbnail-item';
        reader.onload = function(e){ d.innerHTML = '<img src="' + e.target.result + '"><button class="btn-remove-thumb" onclick="pendingFiles.splice('+i+',1);renderPending();event.stopPropagation();">×</button>'; };
        reader.readAsDataURL(f); c.appendChild(d);
    });
    document.getElementById('pendingCount').textContent = pendingFiles.length;
    c.style.display = pendingFiles.length ? 'flex' : 'none'; a.style.display = pendingFiles.length ? 'block' : 'none';
}
function clearPendingFiles() { pendingFiles = []; renderPending(); }

function startAnalysis() {
    showLoading(true, 'AI解析中...'); 
    let done = 0; 
    pendingDrafts = [];
    Promise.all(pendingFiles.map(function(f){ return new Promise(function(res){
        const r = new FileReader(); 
        r.onload = function(e){
            google.script.run.withSuccessHandler(function(json){ if(json.success) pendingDrafts.push(json); done++; document.getElementById('loadingText').textContent = "解析中... (" + done + "/" + pendingFiles.length + ")"; res(); })
            .withFailureHandler(function(){ done++; res(); })
            .uploadAndAnalyzeAndDraft({fileName:f.name, mimeType:f.type, base64:e.target.result.split(',')[1], userName:currentUser.name});
        }; r.readAsDataURL(f);
    })})).then(function(){ 
        showLoading(false); pendingFiles = []; renderPending(); 
        if (pendingDrafts.length > 0) {
            currentDraftIndex = 0;
            showLoading(true, '確認画面を開いています...');
            google.script.run.withSuccessHandler(function(data) {
                showLoading(false);
                if (data) {
                    openEditWithData(data, true);
                    loadHistory(); 
                } else {
                    switchView('history');
                }
            }).getSingleApplicationData(pendingDrafts[0].id);
        } else {
            switchView('history');
        }
    });
}

function loadHistory(cb) { google.script.run.withSuccessHandler(function(d){ historyData = d; renderHistoryTable(d); if(cb) cb(); }).getHistoryData({view:'history'}); }
function renderHistoryTable(data) {
    const tbody = document.getElementById('historyBody'); tbody.innerHTML = '';
    const b = { draft: 'bg-secondary', pending: 'bg-warning text-dark', approved: 'bg-primary', checked: 'bg-info', exported: 'bg-success', rejected: 'bg-danger' };
    const n = { draft: '未申請', pending: '承認待', approved: '承認済', checked: '完了', exported: '完了', rejected: '差戻' };
    data.forEach(function(r){
        const isA = currentUser && ['管理者','経理'].includes(currentUser.role);
        const canE = r.status === 'draft' || r.status === 'rejected' || isA;
        const dup = r.isDuplicate ? '<span class="text-warning ms-1"><i class="fas fa-exclamation-triangle"></i></span>' : '';
        tbody.innerHTML += '<tr><td>' + (r.status === 'draft' ? '<input type="checkbox" class="history-check" value="'+r.id+'" onchange="updateBulkBtn()">' : '') + '</td>' +
            '<td><button class="btn btn-outline-primary btn-edit-unify" onclick="openEditFromHistory(\''+r.id+'\', '+canE+')"><i class="fas '+(canE?'fa-edit':'fa-search')+' me-1"></i>'+(canE?'修正':'確認')+'</button></td>' +
            '<td>'+r.date+'</td><td><b>'+r.store+'</b></td><td><small>'+(r.items[0]?r.items[0].category:'-')+'</small></td><td class="text-end fw-bold">¥'+Number(r.amount).toLocaleString()+'</td>' +
            '<td class="text-center"><span class="badge '+b[r.status]+'">'+n[r.status]+'</span>'+dup+'</td></tr>';
    });
    updateBulkBtn();
}

function updateBulkBtn() { const cnt = document.querySelectorAll('.history-check:checked').length; document.getElementById('selectedCount').textContent = cnt; document.getElementById('btnBulkApply').disabled = cnt === 0; }
function toggleAll(src, sel) { document.querySelectorAll(sel).forEach(function(c){ c.checked = src.checked; }); updateBulkBtn(); }
function submitBulk() { const ids = Array.from(document.querySelectorAll('.history-check:checked')).map(function(c){ return c.value; }); if(confirm('申請しますか？')) { showLoading(true); google.script.run.withSuccessHandler(function(){ showLoading(false); loadHistory(); }).submitBulkApplications(ids); } }

function openEditFromHistory(id, mode) { 
  const r = historyData.find(function(x){ return x.id === id; }); 
  if(r) openEditWithData(r, mode); 
  else { showLoading(true); google.script.run.withSuccessHandler(function(d){ showLoading(false); openEditWithData(d, mode); }).getSingleApplicationData(id); }
}

function openEditWithData(data, edit) {
    if(!data) return;
    const isA = currentUser && ['管理者','経理'].includes(currentUser.role), isE = edit || isA;
    document.getElementById('duplicateAlert').style.display = data.isDuplicate ? 'flex' : 'none';
    const ma = document.getElementById('modalActions'), mt = document.getElementById('modalTitle');
    
    if(isE) {
        const rem = pendingDrafts.length > 0 ? pendingDrafts.length - (currentDraftIndex + 1) : 0;
        let btns = '<button class="btn btn-sm btn-outline-secondary me-2 fw-bold" onclick="editModal.hide()">閉じる</button>';
        if (currentDraftIndex > 0) btns += '<button class="btn btn-sm btn-outline-secondary me-2 fw-bold" onclick="saveAndMove(-1, this)">戻る</button>';
        btns += rem > 0 ? '<button class="btn btn-sm btn-warning fw-bold shadow-sm" onclick="saveAndMove(1, this)">次へ ('+rem+')</button>' : '<button class="btn btn-sm btn-primary fw-bold shadow-sm" onclick="saveData(this)">保存完了</button>';
        ma.innerHTML = btns;
        document.querySelectorAll('#editModal input, #editModal select, #editModal textarea').forEach(function(e){ if(e.id !== 'editUser') e.removeAttribute('readonly'); e.disabled = false; });
        document.querySelector('.edit-only-div').style.display = 'block';
        mt.textContent = '修正・確認';
    } else {
        ma.innerHTML = '<button class="btn btn-sm btn-secondary fw-bold" data-bs-dismiss="modal">閉じる</button>';
        document.querySelectorAll('#editModal input, #editModal select, #editModal textarea').forEach(function(e){ e.setAttribute('readonly', true); });
        document.querySelector('.edit-only-div').style.display = 'none';
        mt.textContent = '詳細確認';
    }
    
    document.getElementById('editId').value = data.id || ''; document.getElementById('editDate').value = data.date || ''; 
    document.getElementById('editUser').value = data.user || (currentUser ? currentUser.name : ''); 
    document.getElementById('editStore').value = data.store || ''; 
    document.getElementById('editAmount').value = data.amount || ''; document.getElementById('editInvoice').checked = !!data.hasInvoice;
    document.getElementById('editGlobalMemo').value = data.globalMemo || '';
    detailData = data.items && data.items.length ? JSON.parse(JSON.stringify(data.items)) : [{category:'', item:'', amount:''}]; 
    renderDetails(!isE);
    
    // --- プレビュー表示の更新 (Base64データを使用) ---
    const img = document.getElementById('previewImage');
    const pdf = document.getElementById('previewPdf');
    const none = document.getElementById('noPreview');
    
    img.style.display = 'none';
    pdf.style.display = 'none';
    none.style.display = 'none';

    if(data.base64Data) {
        if(data.base64Data.includes("application/pdf")) {
            pdf.src = data.base64Data;
            pdf.style.display = 'block';
        } else {
            img.src = data.base64Data;
            img.style.display = 'block';
        }
    } else {
        none.style.display = 'block';
    }
    
    editModal.show();
}

function renderDetails(ro) {
    let h = "";
    detailData.forEach(function(d, i){
        h += '<div class="detail-card shadow-sm"><div class="row g-2">' +
             '<div class="col-12"><input type="text" class="form-control form-control-sm editCat" list="categoryList" value="'+(d.category||'')+'" placeholder="科目" '+(ro?'readonly':'')+'></div>' +
             '<div class="col-12"><input type="text" class="form-control form-control-sm editItem" value="'+(d.item||'')+'" placeholder="品目" '+(ro?'readonly':'')+'></div>' +
             '<div class="col-6"><input type="number" class="form-control form-control-sm editDetailAmount" value="'+(d.amount||'')+'" placeholder="金額" '+(ro?'readonly':'')+'></div>' +
             '<div class="col-6"><select class="form-select form-select-sm editTaxRate" '+(ro?'disabled':'')+'><option value="0.1" selected>10%</option><option value="0.08">8%</option><option value="0">0%</option></select></div>' +
             '</div>' + (ro?'':'<div class="text-end mt-1"><button class="btn btn-sm text-danger p-0" onclick="detailData.splice('+i+',1);renderDetails(false)"><i class="fas fa-trash-alt me-1"></i>削除</button></div>') + '</div>';
    });
    document.getElementById('detailItemsContainer').innerHTML = h;
}

function addDetailItem() { detailData.push({category:'', item:'', amount:''}); renderDetails(false); }
function getPayload() {
    const items = Array.from(document.querySelectorAll('#detailItemsContainer .detail-card')).map(function(c){
        return { category: c.querySelector('.editCat').value, itemName: c.querySelector('.editItem').value, total_price: Number(c.querySelector('.editDetailAmount').value) };
    });
    return { id: document.getElementById('editId').value, useDate: document.getElementById('editDate').value, storeName: document.getElementById('editStore').value, totalAmount: document.getElementById('editAmount').value, hasInvoice: document.getElementById('editInvoice').checked, globalMemo: document.getElementById('editGlobalMemo').value, items: items };
}
function saveData(btn) { if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>'; } google.script.run.withSuccessHandler(function(){ editModal.hide(); loadHistory(); if(document.getElementById('view-admin').style.display !== 'none') loadAdminData(); }).updateApplication(getPayload()); }
function saveAndMove(dir, btn) {
    if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>'; }
    google.script.run.withSuccessHandler(function(){ 
        currentDraftIndex += dir; 
        const nextId = pendingDrafts[currentDraftIndex].id;
        google.script.run.withSuccessHandler(function(data) {
            if(data) openEditWithData(data, true);
        }).getSingleApplicationData(nextId);
    }).updateApplication(getPayload()); 
}
function deleteApp(id) { if(confirm('削除しますか？')) { showLoading(true); google.script.run.withSuccessHandler(function(){ showLoading(false); loadHistory(); }).deleteApplication(id); } }
function loadPresidentData() { google.script.run.withSuccessHandler(function(d){
    let h = "";
    if(!d.length) h = '<tr><td colspan="6" class="text-center py-4 text-muted">なし</td></tr>';
    else d.forEach(function(r){
        h += '<tr><td><input type="checkbox" class="pres-check" value="'+r.id+'"></td>' +
             '<td><button class="btn btn-outline-primary btn-edit-unify" onclick="openEditFromHistory(\''+r.id+'\', false)"><i class="fas fa-search me-1"></i>確認</button></td>' +
             '<td>'+r.user+'</td><td>'+r.date+'</td><td><b>'+r.store+'</b></td><td class="text-end fw-bold">¥'+Number(r.amount).toLocaleString()+'</td></tr>';
    });
    document.getElementById('presidentBody').innerHTML = h;
}).getHistoryData({view:'president'}); }
function approveSelected() { const ids = Array.from(document.querySelectorAll('.pres-check:checked')).map(function(c){ return c.value; }); if(ids.length && confirm('承認しますか？')) { showLoading(true); google.script.run.withSuccessHandler(function(){ showLoading(false); loadPresidentData(); }).approveBulk(ids); } }
function rejectSelectedPrepare() { const ids = Array.from(document.querySelectorAll('.pres-check:checked')).map(function(c){ return c.value; }); if(ids.length) { document.getElementById('rejectCommentInput').dataset.ids = JSON.stringify(ids); rejectModal.show(); } }
function rejectConfirm() { google.script.run.withSuccessHandler(function(){ rejectModal.hide(); loadPresidentData(); }).rejectBulkWithComment(JSON.parse(document.getElementById('rejectCommentInput').dataset.ids), document.getElementById('rejectCommentInput').value); }
function loadMasters() { google.script.run.withSuccessHandler(function(d){ document.getElementById('categoryList').innerHTML = d.accounts.map(function(a){ return '<option value="' + a + '">'; }).join(''); }).getMasters(); }
function showLoading(s, t) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; if(t) document.getElementById('loadingText').textContent = t; }
</script>
</body>
</html>
