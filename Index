<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>クレジット精算アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: "Helvetica Neue", Arial, sans-serif; }
    .navbar { background-color: #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: bold; color: white !important; display: flex; align-items: center; gap: 10px; }
    .nav-link { color: rgba(255,255,255,0.85) !important; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: all 0.2s; }
    .nav-link:hover, .nav-link.active { background-color: rgba(255,255,255,0.2); color: white !important; font-weight: bold; }
    .user-info { color: white; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 15px; margin-left: 10px; font-size: 0.9rem; }
    .drag-area { border: 2px dashed #dee2e6; border-radius: 12px; background: white; padding: 60px 20px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
    .drag-area:hover { border-color: #0d6efd; background-color: #f8faff; }
    .drag-icon-circle { width: 80px; height: 80px; background: #e7f1ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: #0d6efd; }
    .content-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e9ecef; overflow: hidden; }
    .table thead th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; color: #495057; font-weight: 600; }
    
    /* プレビューエリア修正 */
    .preview-frame { width: 100%; height: 100%; border: none; background: #333; }
    .preview-container { height: 100vh; background: #333; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
    
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
    .spinner-border { width: 3rem; height: 3rem; border-width: 0.25em; }

    /* モーダル修正 (Fullscreen対応) */
    .modal-fullscreen .modal-body { overflow-y: hidden; }
    .modal-title-custom { font-size: 1.25rem; font-weight: bold; color: #333; }
    
    /* 明細のコンパクト化と視認性向上 */
    .form-label { font-weight: bold; color: #555; font-size: 0.75rem; margin-bottom: 0.05rem; } /* ラベルを小さく */
    .form-control-sm-custom { font-size: 0.9rem; padding: 0.3rem 0.5rem; } /* コントロールのサイズ調整 */
    
    /* 明細カードのデザイン */
    .detail-card {
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px; /* パディングを小さく */
      margin-top: 5px; /* マージンを小さく */
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .detail-card .row.g-3 > div { padding-top: 0.5rem !important; } /* 行間の調整 */
    .detail-card .bg-light { padding: 8px !important; } /* 金額計算エリアのパディング調整 */

    .btn-add-detail {
      border: 1px dashed #198754;
      color: #198754;
      background: #f8fff9;
      width: 100%;
      padding: 6px;
      border-radius: 5px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .btn-add-detail:hover { background: #e0f8e9; }
    .detail-header-text { font-weight: bold; color: #333; font-size: 0.9rem; }
    
    /* 必須バッジ */
    .badge-required {
      background-color: #dc3545; color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 3px; margin-left: 5px; vertical-align: middle; position: relative; top: -1px;
    }
    
    /* 編集不可時のスタイル */
    .is-readonly input, .is-readonly textarea, .is-readonly select {
        background-color: #e9ecef !important;
        border: 1px solid #ced4da !important;
    }
    /* 金額を太字に */
    .amount-input-style {
      font-weight: bold;
      color: #0d6efd;
      font-size: 1.1rem !important;
    }
    .reject-comment-bubble {
        background-color: #ffebee;
        color: #d32f2f;
        padding: 5px 8px;
        border-radius: 5px;
        font-size: 0.8rem;
        word-break: break-word;
        max-width: 100%;
        margin-top: 5px;
    }
    
    /* ★修正: モーダルのz-index問題を解決するための強制スタイル */
    /* loadingOverlay(9999)よりも確実に上に表示させる */
    .modal { z-index: 10050 !important; }
    /* バックドロップ(黒い背景)はモーダルより下にする */
    .modal-backdrop { z-index: 10040 !important; }
    /* モーダルダイアログ自体も確実に手前に */
    .modal-dialog { z-index: 10060 !important; }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner-border text-primary mb-3" role="status"></div>
  <h5 id="loadingText" class="text-secondary fw-bold">処理中...</h5>
</div>

<nav class="navbar navbar-expand-lg sticky-top mb-4">
  <div class="container-xl">
    <a class="navbar-brand" href="#"><i class="fas fa-file-invoice"></i> クレジット精算</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" onclick="switchView('apply')" href="#">① 登録画面</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchView('history')" href="#">② 全履歴・申請</a></li>
        <li class="nav-item admin-only" style="display:none;"><a class="nav-link" onclick="switchView('admin')" href="#">③ 管理者画面</a></li>
        <li class="nav-item approver-only" style="display:none;"><a class="nav-link" onclick="switchView('president')" href="#">④ 社長画面</a></li>
      </ul>
      <div class="user-info">
        <div id="userName" class="fw-bold">Guest</div>
        <div id="userRole" class="small opacity-75">Initializing...</div>
        <div id="debugEmail" class="text-warning small" style="display:none;"></div>
      </div>
    </div>
  </div>
</nav>

<div class="container-xl pb-5">
  <!-- View: Apply -->
  <div id="view-apply" class="view-section">
    <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-2"><h3 class="fw-bold text-dark m-0">① 経費データ登録</h3></div>
    <div id="uploadArea" class="content-card p-5 text-center mx-auto" style="max-width: 800px;">
      <input type="file" id="fileInput" multiple accept="image/*,application/pdf" style="display:none;" onchange="handleFiles(this.files)">
      <div class="drag-area" onclick="document.getElementById('fileInput').click()" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
        <div class="drag-icon-circle"><i class="fas fa-camera fa-2x"></i></div>
        <h4 class="fw-bold mb-3">領収書を読み込む</h4>
        <p class="text-muted mb-0">ここにファイルをドラッグ＆ドロップ<br>またはクリックして選択 <span class="text-primary small">(複数枚対応)</span></p>
      </div>
      <div class="mt-4 alert alert-info d-inline-block text-start"><small><i class="fas fa-info-circle me-1"></i> AIが内容を解析し、自動的に入力画面が開きます。</small></div>
    </div>
  </div>

  <!-- View: History -->
  <div id="view-history" class="view-section" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
      <h3 class="fw-bold text-dark m-0">② 全履歴・申請</h3>
      <button class="btn btn-outline-primary btn-sm" onclick="loadHistory()"><i class="fas fa-sync-alt"></i> 更新</button>
    </div>
    <div class="alert alert-primary d-flex justify-content-between align-items-center shadow-sm">
      <div class="d-flex align-items-center"><i class="fas fa-check-square fa-lg me-3"></i><div><strong>未申請項目を選択してまとめて申請</strong><br><small>選択中: <span id="selectedCount" class="fw-bold fs-5">0</span> 件</small></div></div>
      <button id="btnBulkApply" class="btn btn-primary fw-bold" disabled onclick="submitBulk()">一括申請する <i class="fas fa-paper-plane ms-2"></i></button>
    </div>
    <div class="content-card"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th width="40" class="text-center"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th><th>利用日</th><th>支払先</th><th>科目・内容</th><th class="text-end">金額</th><th class="text-center">ステータス</th><th class="text-center">操作</th></tr></thead><tbody id="historyBody"></tbody></table></div></div>
  </div>

  <!-- View: President -->
  <div id="view-president" class="view-section" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
      <h3 class="fw-bold text-dark m-0"><i class="fas fa-shield-alt text-warning me-2"></i>承認タスク</h3>
      <button class="btn btn-outline-primary btn-sm" onclick="loadPresidentData()"><i class="fas fa-sync-alt"></i> 更新</button>
    </div>
    <div class="content-card">
      <div class="p-3 bg-light border-bottom d-flex justify-content-between">
        <span class="fw-bold">承認待ち一覧</span>
        <div>
          <button class="btn btn-sm btn-success me-2" onclick="approveSelected()"><i class="fas fa-check me-1"></i>選択を承認</button>
          <!-- ★修正: rejectSelectedPrepareを呼び出す -->
          <button class="btn btn-sm btn-danger" onclick="rejectSelectedPrepare()"><i class="fas fa-times me-1"></i>選択を差戻し</button>
        </div>
      </div>
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th width="40"><input type="checkbox" onchange="toggleAllPres(this)"></th>
            <th>申請者</th>
            <th>利用日</th>
            <th>支払先</th>
            <th class="text-end">金額</th>
          </tr>
        </thead>
        <tbody id="presidentBody"></tbody>
      </table>
    </div>
  </div>

  <!-- View: Admin -->
  <div id="view-admin" class="view-section" style="display:none;">
    <h3 class="fw-bold text-dark mb-4 border-bottom pb-2"><i class="fas fa-user-cog text-success me-2"></i>管理者画面</h3>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="content-card p-4 h-100">
          <h5 class="fw-bold mb-4"><i class="fas fa-file-csv me-2"></i>データ出力</h5>
          <button class="btn btn-outline-primary w-100 mb-2 py-2" onclick="alert('CSV作成処理')">勘定奉行用CSV</button>
          <button class="btn btn-outline-success w-100 py-2" onclick="alert('CSV作成処理')">銀行振込用CSV</button>
        </div>
      </div>
      <div class="col-md-6">
        <div class="content-card p-4 h-100">
          <h5 class="fw-bold mb-4"><i class="fas fa-tasks me-2"></i>未チェックリスト</h5>
          <div id="adminList" style="max-height:300px; overflow-y:auto;"><p class="text-muted text-center py-5">読み込み中...</p></div>
          <button class="btn btn-dark w-100 mt-3" onclick="checkSelectedAdmin()">チェック済みにする</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal (Fullscreen) -->
<div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-body p-0 h-100">
        <input type="hidden" id="editId">
        <div class="row g-0 h-100">
          
          <!-- Left Column: Preview (Fixed Height 100vh) -->
          <div class="col-lg-6 bg-dark preview-container">
            <iframe id="previewFrame" class="preview-frame" src=""></iframe>
            <div id="noPreview" class="text-white text-center" style="display:none;">
              <i class="fas fa-eye-slash fa-3x mb-3"></i><br>プレビューできません
            </div>
          </div>
          
          <!-- Right Column: Input Form (Scrollable) -->
          <div class="col-lg-6 h-100 d-flex flex-column" style="background-color: #f5f7fa;">
            
            <!-- Sticky Header -->
            <div class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center shadow-sm" style="flex-shrink: 0;">
              <!-- ★タイトルを動的に変更 -->
              <h5 class="modal-title-custom m-0" id="modalTitle"><i class="fas fa-edit text-primary me-2"></i>AI解析結果の確認・修正</h5>
              <div id="modalActions">
                <!-- アクションボタンがJSによって動的に配置される -->
              </div>
            </div>

            <!-- Scrollable Content -->
            <div class="p-4" style="overflow-y: auto; flex-grow: 1;">
              
              <!-- 基本情報カード -->
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">申請日 <span class="badge-required edit-only">必須</span></label>
                      <input type="date" class="form-control form-control-sm-custom" id="editDate">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">使用者</label>
                      <input type="text" class="form-control form-control-sm-custom bg-light" id="editUser" readonly>
                    </div>
                    <div class="col-12">
                      <label class="form-label">支払先 <span class="badge-required edit-only">必須</span></label>
                      <input type="text" class="form-control form-control-sm-custom" id="editStore" placeholder="店舗名・会社名">
                    </div>
                    
                    <div class="col-12 border-top pt-3 mt-3">
                       <div class="row g-3 align-items-center">
                          <div class="col-md-5">
                            <div class="form-check">
                              <input type="checkbox" id="editInvoice" class="form-check-input">
                              <label class="form-check-label fw-bold small" for="editInvoice">インボイス番号あり</label>
                            </div>
                          </div>
                          <div class="col-md-7">
                            <label class="form-label small text-muted d-block text-end mb-1">領収書合計 (税込)</label>
                            <input type="number" class="form-control text-end amount-input-style" id="editAmount" placeholder="0">
                          </div>
                       </div>
                    </div>
                    
                    <div class="col-12">
                      <label class="form-label text-muted small">メモ（領収書全体）</label>
                      <input type="text" class="form-control form-control-sm" id="editGlobalMemo" placeholder="全体のメモがあれば入力">
                    </div>
                  </div>
                </div>
              </div>

              <!-- 明細エリア (動的な部分) -->
              <h5 class="detail-header-text mb-2 mt-4"><i class="fas fa-list me-2"></i>明細入力</h5>
              <div id="detailItemsContainer">
                <!-- 明細カードがJavaScriptによりここに追加される -->
              </div>
              
              <div class="mt-3 edit-only">
                <button type="button" class="btn-add-detail" onclick="addDetailItem()"><i class="fas fa-plus me-1"></i>明細を追加</button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- ★修正: Reject Comment Modal から "fade" クラスを削除して確実に表示させる -->
<div class="modal" id="rejectCommentModal" tabindex="-1" aria-modal="true" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i>差戻しコメント入力</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>選択された申請を差し戻します。理由を必ず入力してください。</p>
        <textarea class="form-control" id="rejectCommentInput" rows="4" placeholder="例: 添付ファイルが見当たらない、勘定科目が不適切"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-danger" onclick="rejectSelectedConfirm()">差戻し実行</button>
      </div>
    </div>
  </div>
</div>

<datalist id="categoryList"></datalist>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentUser = null;
let historyData = [];
let detailData = []; // ★明細データを保持する配列

// モーダル変数の定義（初期化はonloadで行う）
let editModal = null;
let rejectModal = null;

// ★複数ファイルアップロード用のグローバル変数
let pendingDrafts = [];
let currentDraftIndex = -1;

window.onload = function() {
  // モーダルの初期化
  editModal = new bootstrap.Modal(document.getElementById('editModal'));
  
  // rejectModalの初期化: 念のためオプションを指定
  const rejectEl = document.getElementById('rejectCommentModal');
  if(rejectEl) {
      rejectModal = new bootstrap.Modal(rejectEl, {
          backdrop: 'static', // 背景クリックで閉じない
          keyboard: false
      });
  }

  showLoading(true, 'ユーザー情報取得中...');
  google.script.run.withSuccessHandler(user => {
    showLoading(false);
    currentUser = user;
    
    if(user.error) {
      // alertは使えないため、console.errorに出力
      console.error(`Login Error: ${user.name} | Reason: ${user.error} | Email: ${user.email}`);
    }

    document.getElementById('userName').textContent = user.name;
    document.getElementById('userRole').textContent = user.role;
    document.getElementById('debugEmail').textContent = user.email;
    
    if(user.role === '社長' || user.role === '経理') document.querySelectorAll('.approver-only').forEach(el=>el.style.display='block');
    if(user.role === '管理者' || user.role === '経理') document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block');

    loadMasters();
    // 最初のビュー表示時に履歴も読み込む
    loadHistory();
  }).withFailureHandler(err => {
    showLoading(false);
    console.error("Initialization Error: " + err.message);
  }).getCurrentUser();
};

function switchView(viewName) {
  document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
  document.getElementById('view-' + viewName).style.display = 'block';
  document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
  // イベントが渡されない場合（onload時など）の対応
  const targetLink = document.querySelector(`.nav-item a[onclick="switchView('${viewName}')"]`);
  if(targetLink) targetLink.classList.add('active');

  if(viewName === 'history') loadHistory();
  if(viewName === 'president') loadPresidentData();
  if(viewName === 'admin') loadAdminData();
}

function handleDrop(e) { e.preventDefault(); handleFiles(e.dataTransfer.files); }

function handleFiles(files) {
  if(!files.length) return;
  showLoading(true, `AI解析中... (0/${files.length})`);
  
  // ★複数ファイル対応のための初期化
  const filesArray = Array.from(files);
  pendingDrafts = [];
  currentDraftIndex = -1;
  let completedCount = 0;

  const processNextFile = (file, index) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const payload = { fileName: file.name, mimeType: file.type, base64: e.target.result.split(',')[1], userName: currentUser.name };
            
            google.script.run.withSuccessHandler((res) => {
                completedCount++;
                if(res && res.success) {
                    // 成功した下書きデータを配列に追加 (この時点ではIDと最低限の情報のみ)
                    pendingDrafts.push({id: res.id, name: file.name, fileId: res.fileId});
                } else {
                    console.error(`File ${file.name} analysis failed: `, res);
                }
                document.getElementById('loadingText').textContent = `AI解析中... (${completedCount}/${filesArray.length})`;
                resolve();
            }).withFailureHandler(err => {
                console.error("アップロードエラー: " + err.message);
                completedCount++;
                document.getElementById('loadingText').textContent = `AI解析中... (${completedCount}/${filesArray.length})`;
                resolve(); // 失敗しても次の処理へ
            }).uploadAndAnalyzeAndDraft(payload);
        };
        reader.readAsDataURL(file);
    });
  };

  // 全ファイルを順次処理
  let promiseChain = Promise.resolve();
  filesArray.forEach((file, index) => {
    promiseChain = promiseChain.then(() => processNextFile(file, index));
  });

  promiseChain.then(() => {
    showLoading(false);
    
    if (pendingDrafts.length > 0) {
      // 全ファイルの下書き保存が完了したら、履歴をリロードし、編集ワークフローを開始
      loadHistory(() => {
          // historyDataから、pendingDraftsのIDを持つデータを取得し直し、完全なデータとする
          pendingDrafts = pendingDrafts.map(draft => historyData.find(r => r.id === draft.id)).filter(Boolean);
          startMultiDraftEdit();
      });
    } else {
      // エラーなどで1件も保存できなかった場合、履歴画面へ
      switchView('history');
      // console.log("No drafts were created successfully.");
    }
  });
}


// ★複数ファイル編集ワークフロー開始
function startMultiDraftEdit() {
    if (pendingDrafts.length === 0) {
        switchView('history');
        return;
    }
    currentDraftIndex = 0;
    // pendingDraftsには既にhistoryDataから取得し直した完全なデータが入っている
    openEditWithData(pendingDrafts[currentDraftIndex], true);
}

function loadHistory(callback) {
  google.script.run.withSuccessHandler(data => {
    historyData = data;
    renderHistoryTable(data);
    if(callback) callback();
  }).getHistoryData({view: 'history'});
}

function renderHistoryTable(data) {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '';
  if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">履歴がありません</td></tr>'; return; }
  const statusBadges = { draft: '<span class="badge bg-secondary">未申請</span>', pending: '<span class="badge bg-warning text-dark">承認待ち</span>', approved: '<span class="badge bg-primary">社長承認済</span>', checked: '<span class="badge bg-success">経理確認済</span>', rejected: '<span class="badge bg-danger">差戻し</span>' };
  data.forEach(row => {
    // ★差し戻しの場合も編集を許可する
    const isDraftOrRejected = row.status === 'draft' || row.status === 'rejected';
    
    const tr = document.createElement('tr');
    
    // ★操作ボタンを修正
    let actionButton;
    if (isDraftOrRejected) {
        // 未申請 or 差戻し => 修正 & 削除
        actionButton = `<button class="btn btn-link btn-sm p-0 me-2" onclick="openEditFromHistory('${row.id}', true)"><i class="fas fa-edit"></i> 修正</button><button class="btn btn-link btn-sm p-0 text-danger" onclick="deleteApp('${row.id}')"><i class="fas fa-trash-alt"></i> 削除</button>`;
    } else {
        // 申請中/承認済み => 詳細確認
        const isApprover = currentUser.role === '社長' || currentUser.role === '経理' || currentUser.role === '管理者';
        const isSelf = row.user === currentUser.name;
        
        if (isApprover || isSelf) {
            actionButton = `<button class="btn btn-link btn-sm p-0 text-primary" onclick="openEditFromHistory('${row.id}', false)"><i class="fas fa-eye"></i> 詳細確認</button>`;
        } else {
            actionButton = `<span class="text-muted small">-</span>`;
        }
    }
    
    // ★ステータス表示に差し戻しコメントを追加
    let statusCell = statusBadges[row.status] || row.status;
    if (row.status === 'rejected' && row.rejectComment) {
        statusCell += `<div class="reject-comment-bubble"><i class="fas fa-comment-dots me-1"></i> ${row.rejectComment}</div>`;
    }
    
    // 申請可能なのは draft のみ
    const canCheck = row.status === 'draft';

    tr.innerHTML = `<td class="text-center">${canCheck ? `<input type="checkbox" class="form-check-input history-check" value="${row.id}" onchange="updateBulkBtn()">` : ''}</td><td>${row.date}</td><td><div class="fw-bold">${row.store}</div></td><td><div>${row.items[0]?.category||'-'}</div><div class="small text-muted">${row.items[0]?.item||''}</div></td><td class="text-end fw-bold font-monospace">¥${Number(row.amount).toLocaleString()}</td><td class="text-center">${statusCell}</td><td class="text-center">${actionButton}</td>`;
    tbody.appendChild(tr);
  });
  updateBulkBtn();
}

function updateBulkBtn() {
  const cnt = document.querySelectorAll('.history-check:checked').length;
  document.getElementById('selectedCount').textContent = cnt;
  document.getElementById('btnBulkApply').disabled = cnt === 0;
}
function toggleAll(source) { document.querySelectorAll('.history-check').forEach(c => c.checked = source.checked); updateBulkBtn(); }
function submitBulk() {
  const ids = Array.from(document.querySelectorAll('.history-check:checked')).map(c => c.value);
  // ★ alert/confirm の代わりにカスタムモーダルまたはコンソールメッセージを使用
  if(!window.confirm(`${ids.length}件を申請しますか？`)) return; 
  showLoading(true, '申請中...');
  google.script.run.withSuccessHandler(() => { showLoading(false); loadHistory(); }).submitBulkApplications(ids);
}

// ★修正: isEditModeフラグを追加
function openEditFromHistory(id, isEditMode) {
  // 複数編集ワークフローをリセット
  pendingDrafts = [];
  currentDraftIndex = -1;
  
  const row = historyData.find(r => r.id === id);
  if(!row) {
    // historyDataにない、承認待ちのデータかもしれないため、GASから取得を試みる
    google.script.run.withSuccessHandler(data => {
        if(data) openEditWithData(data, isEditMode);
        else console.error("History data not found for ID: " + id);
    }).getSingleApplicationData(id);
    return;
  }
  
  // historyDataにデータがある場合は直接開く
  openEditWithData(row, isEditMode);
}

// 自動計算ロジック
function calculateTax(index) {
  const container = document.getElementById(`detail-card-${index}`);
  const amountInput = container.querySelector('.editDetailAmount');
  const rateSelect = container.querySelector('.editTaxRate');
  const excludedInput = container.querySelector('.editTaxExcluded');
  const taxInput = container.querySelector('.editTax');
  
  const amount = parseFloat(amountInput.value) || 0;
  // taxRateが select要素なので、valueを取得
  const rate = parseFloat(rateSelect.value) || 0;
  
  if (amount > 0 && rate > 0) {
    // 1 + rate で割ると税抜額
    const excluded = Math.round(amount / (1 + rate));
    const tax = amount - excluded;
    
    excludedInput.value = excluded;
    taxInput.value = tax;
  } else if (amount > 0 && rate === 0) {
    // 0%の場合、税抜額 = 税込額, 税 = 0
    excludedInput.value = amount;
    taxInput.value = 0;
  } else {
    excludedInput.value = '';
    taxInput.value = '';
  }
}

// 接待交際費の自動判定ロジック
function checkEntertainmentExpense(index) {
  const container = document.getElementById(`detail-card-${index}`);
  const catInput = container.querySelector('.editCat');
  const amountInput = container.querySelector('.editDetailAmount');
  const participantsInput = container.querySelector('.editParticipants');

  let category = catInput.value;
  // 既に適切なカテゴリが設定されていなければ処理をスキップ
  if (category !== '接待交際費' && category !== '少額接待交際費') return;

  const amount = parseFloat(amountInput.value) || 0;
  // 全角数字を半角に変換し、数字以外を除去
  const participantsStr = participantsInput.value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '');
  const participants = parseInt(participantsStr) || 0;

  if (amount > 0 && participants > 0) {
    const perPerson = amount / participants;
    // 1人あたり5000円（税抜）ルールを適用するため、税抜額で判断するのが適切だが、ここでは税込額で簡易判断
    // 領収書の合計(税込)をベースにしているため、ここでは10000円で判断するロジックを維持
    if (perPerson <= 10000) {
      if (category !== '少額接待交際費') {
        catInput.value = '少額接待交際費';
      }
    } else {
      if (category !== '接待交際費') {
        catInput.value = '接待交際費';
      }
    }
  }
}

// 明細アイテムのHTMLテンプレート
function getDetailItemTemplate(item, index, isReadOnly) {
  // item: { id:..., category:..., item:..., amount:..., client:..., participants:..., memo:... }
  const itemAmount = item.amount || '';
  const taxRate = '0.10'; // 一旦固定
  const readonlyAttr = isReadOnly ? 'readonly' : '';
  const inputClass = isReadOnly ? 'bg-light' : '';

  // 税額計算 (初期値用)
  const initialAmount = parseFloat(itemAmount) || 0;
  const initialRate = parseFloat(taxRate) || 0;
  let initialExcluded = '';
  let initialTax = '';
  if (initialAmount > 0 && initialRate > 0) {
      initialExcluded = Math.round(initialAmount / (1 + initialRate));
      initialTax = initialAmount - initialExcluded;
  } else if (initialAmount > 0 && initialRate === 0) {
      initialExcluded = initialAmount;
      initialTax = 0;
  }

  return `
    <div class="detail-card mb-3 ${isReadOnly ? 'is-readonly' : ''}" id="detail-card-${index}">
      <div class="d-flex justify-content-between align-items-center mb-2" style="border-bottom: 1px solid #eee; padding-bottom: 5px;">
        <span class="detail-header-text"><i class="fas fa-list-ul me-2"></i>明細 ${index + 1}</span>
        ${isReadOnly ? '' : `<button type="button" class="btn btn-sm btn-outline-danger p-0 px-2" onclick="removeDetailItem(${index})" style="line-height: 1;"><i class="fas fa-trash-alt me-1"></i>削除</button>`}
      </div>
      
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">勘定科目 <span class="badge-required edit-only">必須</span></label>
          <input type="text" class="form-control form-control-sm-custom editCat ${inputClass}" list="categoryList" placeholder="科目を選択" value="${item.category || ''}" oninput="checkEntertainmentExpense(${index})" ${readonlyAttr}>
        </div>
        
        <div class="col-12">
          <label class="form-label">品目 <span class="badge-required edit-only">必須</span></label>
          <input type="text" class="form-control form-control-sm-custom editItem ${inputClass}" placeholder="品名" value="${item.item || ''}" ${readonlyAttr}>
        </div>
        
        <div class="col-md-6">
          <label class="form-label">取引先</label>
          <input type="text" class="form-control form-control-sm-custom editClient ${inputClass}" placeholder="相手先" value="${item.client || ''}" ${readonlyAttr}>
        </div>
        <div class="col-md-6">
          <label class="form-label">参加人数</label>
          <input type="text" class="form-control form-control-sm-custom editParticipants ${inputClass}" placeholder="例: 4名" value="${item.participants || ''}" oninput="checkEntertainmentExpense(${index})" ${readonlyAttr}>
        </div>

        <!-- 金額計算エリア -->
        <div class="col-12 bg-light p-3 rounded mt-3">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label text-primary">金額（税込）</label>
              <input type="number" class="form-control form-control-sm-custom text-end editDetailAmount amount-input-style ${inputClass}" placeholder="0" value="${itemAmount}" oninput="calculateTax(${index}); checkEntertainmentExpense(${index})" ${readonlyAttr}>
            </div>
            <div class="col-md-6">
              <label class="form-label">消費税率</label>
              <select class="form-select form-select-sm editTaxRate ${inputClass}" onchange="calculateTax(${index})" ${readonlyAttr}>
                <option value="0.10" ${taxRate === '0.10' ? 'selected' : ''}>10%</option>
                <option value="0.08" ${taxRate === '0.08' ? 'selected' : ''}>8%</option>
                <option value="0" ${taxRate === '0' ? 'selected' : ''}>0%</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label small text-muted">税抜合計</label>
              <input type="number" class="form-control form-control-sm text-end bg-white editTaxExcluded" value="${initialExcluded}" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted">消費税</label>
              <input type="number" class="form-control form-control-sm text-end bg-white editTax" value="${initialTax}" readonly>
            </div>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">メモ（明細）</label>
          <textarea class="form-control form-control-sm editMemo ${inputClass}" rows="2" placeholder="詳細メモ" ${readonlyAttr}>${item.memo || ''}</textarea>
        </div>
      </div>
    </div>
  `;
}

// 明細の動的な描画
function renderDetailItems(isReadOnly) {
  const container = document.getElementById('detailItemsContainer');
  container.innerHTML = '';
  detailData.forEach((item, index) => {
    container.innerHTML += getDetailItemTemplate(item, index, isReadOnly);
    // 初回描画時に税額計算を実行して表示を正確にする
    // calculateTax(index); // テンプレートで初期値設定済みのため不要だが、念のためコメントアウト
  });
}

// 新しい明細を追加
function addDetailItem() {
  const newItem = { category: '', item: '', amount: '', client: '', participants: '', memo: '' };
  detailData.push(newItem);
  renderDetailItems(false); // 編集モードで再描画
}

// 明細を削除
function removeDetailItem(index) {
  if(detailData.length === 1) {
    // alert("明細は最低1つ必要です。");
    console.warn("Detail items require at least one entry.");
    return;
  }
  detailData.splice(index, 1);
  renderDetailItems(false); // 編集モードで再描画
}


// ★修正: openEditWithData関数にisEditModeフラグを追加
function openEditWithData(data, isEditMode) {
  const modalTitle = document.getElementById('modalTitle');
  const modalActions = document.getElementById('modalActions');
  const formControls = document.querySelectorAll('#editModal input, #editModal select, #editModal textarea');
  const editOnlyElements = document.querySelectorAll('#editModal .edit-only');

  // モーダル全体の状態を設定
  if (isEditMode) {
      // ★マルチドラフト編集中の場合、ボタンを「次へ」に変更
      const isMultiDraft = pendingDrafts.length > 0;
      const remainingDrafts = isMultiDraft ? pendingDrafts.length - (currentDraftIndex + 1) : 0;
      
      if (isMultiDraft && remainingDrafts >= 0) { // 編集中のファイルも数に含めるため >= 0
          
          if (remainingDrafts > 0) {
              // 次のファイルがある場合
              modalActions.innerHTML = `<button type="button" class="btn btn-outline-secondary me-2" onclick="cancelEdit(true)">キャンセル</button><button type="button" class="btn btn-warning px-4 fw-bold shadow-sm" onclick="saveAndNextDraft()">次へ <span class="badge bg-light text-warning ms-1">${remainingDrafts}</span> <i class="fas fa-arrow-right ms-1"></i></button>`;
              modalTitle.innerHTML = `<i class="fas fa-edit text-primary me-2"></i>領収書編集中 (${currentDraftIndex + 1}/${pendingDrafts.length}枚目)`;
          } else {
              // 最後の1枚 (remainingDrafts === 0)
              modalActions.innerHTML = `<button type="button" class="btn btn-outline-secondary me-2" onclick="cancelEdit(true)">キャンセル</button><button type="button" class="btn btn-primary px-4 fw-bold shadow-sm" onclick="saveEdit()"><i class="fas fa-check me-2"></i>登録完了</button>`;
              modalTitle.innerHTML = `<i class="fas fa-edit text-primary me-2"></i>最後の領収書確認 (${currentDraftIndex + 1}/${pendingDrafts.length}枚目)`;
          }

      } else {
          // 履歴からの単独編集の場合
          modalTitle.innerHTML = `<i class="fas fa-edit text-primary me-2"></i>AI解析結果の確認・修正`;
          modalActions.innerHTML = `<button type="button" class="btn btn-outline-secondary me-2" onclick="cancelEdit(false)">キャンセル</button><button type="button" class="btn btn-primary px-4 fw-bold shadow-sm" onclick="saveEdit()"><i class="fas fa-check me-2"></i>登録完了</button>`;
      }
      
      formControls.forEach(el => { el.removeAttribute('readonly'); el.classList.remove('bg-light'); });
      editOnlyElements.forEach(el => el.style.display = 'inline');

  } else { // 詳細確認モード (社長/申請済みユーザー)
      modalTitle.innerHTML = `<i class="fas fa-eye text-success me-2"></i>登録詳細の確認 (ID: ${data.id ? data.id.substring(0, 8) : 'N/A'}...)`;
      modalActions.innerHTML = `<button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">閉じる</button>`;
      
      // 編集不可にする
      formControls.forEach(el => { 
          // editUser, editTaxExcluded, editTax は元々readonlyなので、それ以外をreadonlyにする
          if(el.id !== 'editUser' && el.id !== 'editTaxExcluded' && el.id !== 'editTax') {
              el.setAttribute('readonly', true);
              el.classList.add('bg-light');
          }
      });
      // 必須マークや追加ボタンを非表示に
      editOnlyElements.forEach(el => el.style.display = 'none');
  }

  document.getElementById('editId').value = data.id || '';
  document.getElementById('editDate').value = data.date || '';
  // 履歴からのデータにはuserが含まれている (data.user)
  document.getElementById('editUser').value = data.user || (currentUser ? currentUser.name : 'Guest'); 
  document.getElementById('editStore').value = data.store || '';
  document.getElementById('editAmount').value = data.amount || '';
  document.getElementById('editInvoice').checked = !!data.hasInvoice;
  document.getElementById('editGlobalMemo').value = data.globalMemo || '';
  
  // ★明細データを初期化し、描画 (isEditModeを渡す)
  // data.itemsはGASから取得した最新の明細配列
  if(data.items && data.items.length > 0) {
    // ディープコピー
    detailData = JSON.parse(JSON.stringify(data.items));
  } else {
    detailData = [{category: '', item: '', amount: '', client: '', participants: '', memo: ''}];
  }

  renderDetailItems(!isEditMode);
  
  const previewFrame = document.getElementById('previewFrame');
  const noPreview = document.getElementById('noPreview');
  
  // fileId があり、かつ 'NO_FILE' でない場合のみプレビューを表示
  if (data.fileId && data.fileId !== 'NO_FILE') {
    previewFrame.src = `https://drive.google.com/file/d/${data.fileId}/preview`;
    previewFrame.style.display = 'block';
    noPreview.style.display = 'none';
  } else {
    previewFrame.src = '';
    previewFrame.style.display = 'none';
    noPreview.style.display = 'block';
  }
  
  editModal.show();
}

function cancelEdit(isMultiDraft) {
    if (isMultiDraft) {
        // alert/confirm の代わりにカスタムモーダルまたはコンソールメッセージを使用
        if (window.confirm("複数編集を中止しますか？未保存の修正は破棄されます。")) {
            pendingDrafts = [];
            currentDraftIndex = -1;
            editModal.hide();
            switchView('history');
        }
    } else {
        editModal.hide();
    }
}

// UI上の現在の編集内容をJSON形式で取得
function getFormPayload() {
    const updatedItems = [];
    const itemContainers = document.querySelectorAll('#detailItemsContainer .detail-card');

    itemContainers.forEach(container => {
        const amount = parseFloat(container.querySelector('.editDetailAmount').value) || 0;

        updatedItems.push({
            category: container.querySelector('.editCat').value, 
            itemName: container.querySelector('.editItem').value, 
            total_price: amount, 
            client: container.querySelector('.editClient').value,
            participants: container.querySelector('.editParticipants').value,
            memo: container.querySelector('.editMemo').value
        });
    });

    const payload = {
        id: document.getElementById('editId').value,
        useDate: document.getElementById('editDate').value,
        storeName: document.getElementById('editStore').value,
        totalAmount: document.getElementById('editAmount').value, 
        hasInvoice: document.getElementById('editInvoice').checked,
        globalMemo: document.getElementById('editGlobalMemo').value, 
        items: updatedItems
    };
    return payload;
}

// 必須チェック
function validatePayload(payload) {
    if (!payload.useDate || !payload.storeName || !payload.totalAmount) {
        // alertの代わりに
        console.error("Validation Error: 申請日、支払先、領収書合計金額は必須です。");
        window.alert("申請日、支払先、領収書合計金額は必須です。");
        return false;
    }
    if (payload.items.some(item => !item.category || !item.itemName)) {
        // alertの代わりに
        console.error("Validation Error: すべての明細について、勘定科目と品目を入力してください。");
        window.alert("すべての明細について、勘定科目と品目を入力してください。");
        return false;
    }
    return true;
}


// ★登録完了ボタンの処理 (最後の1枚または単独編集)
function saveEdit() {
    const payload = getFormPayload();
    if (!validatePayload(payload)) return;

    showLoading(true, '保存中...');
    
    google.script.run.withSuccessHandler(() => {
        // ★修正: 登録完了時にローディング解除、モーダルクローズ、履歴更新を確実に行う
        showLoading(false);
        editModal.hide(); // モーダルを閉じる
        
        // 複数編集ワークフローを完了させる
        pendingDrafts = [];
        currentDraftIndex = -1;
        
        // 履歴を更新し、履歴画面へ移動
        loadHistory(() => {
            switchView('history'); 
        });
        
    }).withFailureHandler(err => {
        showLoading(false); 
        console.error("登録中にエラーが発生しました: " + err);
        window.alert("登録中にエラーが発生しました: " + err);
    }).updateApplication(payload);
}

// ★次へボタンの処理
function saveAndNextDraft() {
    const payload = getFormPayload();
    if (!validatePayload(payload)) return;

    showLoading(true, `下書き保存中... (${currentDraftIndex + 1}/${pendingDrafts.length})`);

    google.script.run.withSuccessHandler(() => {
        // 1. 次のドラフトへインデックスを進める
        const nextIndex = currentDraftIndex + 1;
        
        // 2. 履歴をリロード (最新のデータを取得するため)
        loadHistory(() => {
            showLoading(false);
            
            // 3. 次のドラフトを開く
            if (nextIndex < pendingDrafts.length) {
                currentDraftIndex = nextIndex;
                // pendingDraftsは既にリロードされたhistoryDataから最新の完全なデータに更新されている
                const nextDraftData = historyData.find(r => r.id === pendingDrafts[currentDraftIndex].id);
                
                if (nextDraftData) {
                    openEditWithData(nextDraftData, true); // 次の編集画面を開く
                } else {
                    console.error("次のデータが見つかりませんでした。ワークフローを終了します。");
                    window.alert("次のデータが見つかりませんでした。ワークフローを終了します。");
                    pendingDrafts = [];
                    currentDraftIndex = -1;
                    editModal.hide();
                    switchView('history');
                }
            } else {
                // 全てのドラフトの編集が完了
                pendingDrafts = [];
                currentDraftIndex = -1;
                editModal.hide();
                switchView('history');
                // window.alert("すべての領収書の登録が完了しました。"); // 最後の saveEdit() に任せる
            }
        });

    }).withFailureHandler(err => {
        showLoading(false); 
        console.error("下書き保存中にエラーが発生しました: " + err);
        window.alert("下書き保存中にエラーが発生しました: " + err);
    }).updateApplication(payload);
}


function deleteApp(id) { 
  if(!window.confirm('削除しますか？')) return; 
  showLoading(true); 
  google.script.run.withSuccessHandler(() => { 
    showLoading(false); 
    loadHistory(); 
  }).deleteApplication(id); 
}

// ★差戻し準備: コメントモーダルを表示 (社長画面のボタンから呼び出される)
function rejectSelectedPrepare() {
  const ids = Array.from(document.querySelectorAll('.pres-check:checked')).map(c => c.value);
  if(ids.length === 0) {
    showLoading(false); // ★選択がない場合にローディングオーバーレイを確実に解除
    window.alert("差戻し対象を選択してください。");
    return;
  }
  
  // ★重要: rejectModalが正常に初期化されているかチェック
  if (!rejectModal) {
      // 初期化されていなければ再取得を試みる (安全策)
      rejectModal = new bootstrap.Modal(document.getElementById('rejectCommentModal'));
      if(!rejectModal) {
         console.error("Error: rejectCommentModal is not initialized correctly.");
         window.alert("システムエラー: 差戻し処理に必要なウィンドウが開けませんでした。ブラウザを更新して再度お試しください。");
         return;
      }
  }
  
  // 処理対象IDを一時的に保持
  document.getElementById('rejectCommentInput').dataset.rejectIds = JSON.stringify(ids);
  document.getElementById('rejectCommentInput').value = '';
  
  // ★修正: JSによる強制表示（Bootstrapのshowメソッドが失敗する場合の対策）
  // まずBootstrapのshowを呼ぶ
  rejectModal.show();
  
  // 念のため少し遅れて強制的にdisplay:blockにする
  setTimeout(() => {
      const el = document.getElementById('rejectCommentModal');
      if(el && getComputedStyle(el).display === 'none') {
          console.warn('Forcing modal display');
          el.style.display = 'block';
          el.classList.add('show');
          // バックドロップがない場合は追加する（簡易的）
          if(!document.querySelector('.modal-backdrop')) {
              const bd = document.createElement('div');
              bd.className = 'modal-backdrop show';
              document.body.appendChild(bd);
          }
      }
  }, 100);
}

// ★差戻し実行: コメントを付けて処理
function rejectSelectedConfirm() {
  const ids = JSON.parse(document.getElementById('rejectCommentInput').dataset.rejectIds);
  const comment = document.getElementById('rejectCommentInput').value.trim();
  
  if (!comment) {
    window.alert("差戻しコメントは必須です。");
    return;
  }
  
  // ★修正：無理なスタイル操作を削除し、Bootstrap標準のhideメソッドのみを使用
  rejectModal.hide();
  // 強制表示させた場合の掃除
  const el = document.getElementById('rejectCommentModal');
  if(el) {
      el.style.display = ''; 
      el.classList.remove('show');
  }
  const bd = document.querySelector('.modal-backdrop');
  if(bd) bd.remove();

  showLoading(true, '差戻し処理中...');
  
  // GAS側にIDsとコメントを渡す関数を呼び出す
  google.script.run.withSuccessHandler(() => { 
    showLoading(false); 
    loadPresidentData(); 
    // historyDataをリロードして、申請者が最新の状態を確認できるようにする
    loadHistory(); 
  }).withFailureHandler(err => {
      showLoading(false); // エラー時もローディングを解除
      // alert("差戻し中にエラーが発生しました: " + err);
      console.error("Reject Error: " + err);
      window.alert("差戻し中にエラーが発生しました: " + err);
  }).rejectBulkWithComment(ids, comment);
}


// ★社長承認画面のリストから詳細確認を開く機能を追加 (isEditMode: false)
function openPresidentDetail(id) {
  // 承認待ちデータはhistoryDataに含まれない可能性があるため、GASから直接取得を試みる
  google.script.run.withSuccessHandler(data => {
      if (data) {
          openEditWithData(data, false); // 詳細確認モード
      } else {
          // alert("データが見つかりませんでした。");
          console.error("Data not found for President Detail: " + id);
          window.alert("データが見つかりませんでした。");
      }
  }).getSingleApplicationData(id);
}


function loadPresidentData() { 
  google.script.run.withSuccessHandler(data => { 
    const tbody = document.getElementById('presidentBody'); 
    // ★承認待ちリストの申請者名にクリックイベントを設定
    tbody.innerHTML = data.map(r => `<tr><td><input type="checkbox" class="pres-check" value="${r.id}"></td><td><button class="btn btn-link btn-sm p-0 me-2" onclick="openPresidentDetail('${r.id}')">${r.user}</button></td><td>${r.date}</td><td>${r.store}</td><td class="text-end">¥${Number(r.amount).toLocaleString()}</td></tr>`).join('') || '<tr><td colspan="5" class="text-center p-4">なし</td></tr>'; 
  }).getHistoryData({view: 'president'}); 
}
// ★承認画面の全選択機能を追加
function toggleAllPres(source) {
  document.querySelectorAll('.pres-check').forEach(c => c.checked = source.checked);
}

function loadAdminData() { google.script.run.withSuccessHandler(data => { const div = document.getElementById('adminList'); div.innerHTML = data.map(r => `<div class="d-flex justify-content-between border-bottom p-2"><div><input type="checkbox" class="admin-check me-2" value="${r.id}"><span class="fw-bold">${r.user}</span> - ${r.store}</div><span class="font-monospace">¥${Number(r.amount).toLocaleString()}</span></div>`).join('') || '<p class="text-center p-3">未チェックデータなし</p>'; }).getHistoryData({view: 'admin'}); }
function approveSelected() { processBulk('approveBulk', '.pres-check'); }
function checkSelectedAdmin() { processBulk('checkBulk', '.admin-check'); }
function processBulk(funcName, selector) { 
    const ids = Array.from(document.querySelectorAll(`${selector}:checked`)).map(c => c.value); 
    if(ids.length === 0) {
        // alertの代わりに
        window.alert("処理対象を選択してください。");
        return;
    }
    
    // rejectSelectedPrepare() から呼び出されるため、rejectBulk の場合は何もしない
    if (funcName.includes('reject')) { return; } 
    
    // confirmの代わりに
    if(!window.confirm(`${ids.length}件を${funcName.includes('approve') ? '承認' : 'チェック済み'}にしますか？`)) return;
    
    showLoading(true); 
    google.script.run.withSuccessHandler(() => { 
        showLoading(false); 
        if(funcName.includes('check')) loadAdminData(); 
        else loadPresidentData(); 
    }).withFailureHandler(err => {
        showLoading(false);
        // alertの代わりに
        console.error("Bulk Process Error: " + err);
        window.alert("一括処理中にエラーが発生しました: " + err);
    })[funcName](ids); 
}
function loadMasters() { google.script.run.withSuccessHandler(data => { const dl = document.getElementById('categoryList'); dl.innerHTML = data.accounts.map(a => `<option value="${a}">`).join(''); }).getMasters(); }
function showLoading(show, text) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; if(text) document.getElementById('loadingText').textContent = text; }
</script>
</body>
</html>
